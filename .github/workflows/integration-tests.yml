name: Integration Tests
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  integration-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - go-version: "1.25.1" # pairs with TinyGo 0.39.0+
            tinygo-version: "0.39.0"
            tinygo-wasi-target: "wasip1"
          - go-version: "1.23.12" # pairs with TinyGo 0.33.0+
            tinygo-version: "0.35.0"
            tinygo-wasi-target: "wasip1"

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - uses: ./.github/actions/install-tinygo
        with:
          tinygo-version: ${{ matrix.tinygo-version }}
      - run: tinygo version

      - name: Setup Fastly CLI
        uses: fastly/compute-actions/setup@v11
        with:
          verbose: true
      - run: fastly version

      - name: Tests - Go
        run: make test-go

      - name: Integration Tests - Go
        run: make test-integration-go

      - name: Tests - TinyGo
        # The slightly different TINYGO_TARGET and GO_BUILD_FLAGS for older
        # versions of TinyGo can be removed once all versions are consistent.
        run: make test-tinygo TINYGO_TARGET=./targets/fastly-compute-${{ matrix.tinygo-wasi-target }}.json GO_BUILD_FLAGS="-tags='fastlyinternaldebug nofastlyhostcalls'"

      - name: Integration Tests - TinyGo
        # The slightly different TINYGO_TARGET for older versions of TinyGo can
        # be removed once all versions are consistent.
        run: make test-integration-tinygo TINYGO_TARGET=./targets/fastly-compute-${{ matrix.tinygo-wasi-target }}.json
