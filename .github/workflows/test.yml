# Tests the codebase.
name: Test
permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  get-go-version:
    uses: ./.github/workflows/reusable-go-version.yml

  lint:
    runs-on: ubuntu-latest
    needs: get-go-version
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.get-go-version.outputs.go-version-latest }}

      - name: vet
        run: go vet ./...

      - name: staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

      - name: nilness
        run: |
          go install golang.org/x/tools/go/analysis/passes/nilness/cmd/nilness@master
          nilness ./...

      - name: ineffassign
        run: |
          go install github.com/gordonklaus/ineffassign@latest
          ineffassign ./...

  test:
    runs-on: ubuntu-latest
    needs: go-version
    strategy:
      matrix:
        include:
          - go-version: ${{ needs.go-version.outputs.latest-version }}
            tinygo-version: ${{ needs.go-version.outputs.tinygo-latest-version }}
          - go-version: ${{ needs.go-version.outputs.mod-version }}
            tinygo-version: ${{ needs.go-version.outputs.tinygo-mod-version }}

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Setup Fastly CLI
        uses: fastly/compute-actions/setup@v11

      - name: Symlink Viceroy to expected location
        run: |
          fastly version
          ln -s "$(which viceroy)" "${XDG_CONFIG_HOME:-$HOME/.config}/fastly/viceroy"

      - name: Tests - Go
        run: make test-go

      # Test TinyGo once Go tests have passed

      - uses: acifani/setup-tinygo@v2
        with:
          tinygo-version: ${{ matrix.tinygo-version }}

      - name: Tests - TinyGo
        run: make test-tinygo
