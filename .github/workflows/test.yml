# Tests the codebase.
name: Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  go-mod-version:
    runs-on: ubuntu-latest
    outputs:
      go-version-mod: ${{ steps.get-versions.outputs.mod }}
      go-version-latest: ${{ steps.get-versions.outputs.latest }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: "stable"
      - id: get-versions
        run: |
          output=$(go list -m -u go)
          mod_version=$(echo "$output" | awk '{print $2}')
          latest_version=$(echo "$output" | awk '{print $3}' | tr -d '[]')
          latest_version=${latest_version:-$mod_version}
          echo "mod=${mod_version}" >> $GITHUB_OUTPUT
          echo "latest=${latest_version}" >> $GITHUB_OUTPUT
      - name: Download Go modules
        run: go mod download

  lint:
    runs-on: ubuntu-latest
    needs: go-mod-version
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go-mod-version.outputs.go-version-latest }}

      - name: vet
        run: go vet ./...

      - name: staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

      - name: nilness
        run: |
          go install golang.org/x/tools/go/analysis/passes/nilness/cmd/nilness@master
          nilness ./...

      - name: ineffassign
        run: |
          go install github.com/gordonklaus/ineffassign@latest
          ineffassign ./...

  test:
    runs-on: ubuntu-latest
    needs: go-mod-version
    strategy:
      matrix:
        include:
          - go-version: ${{ needs.go-mod-version.outputs.go-version-latest }}
            tinygo-version: "0.39.0"
          - go-version: ${{ needs.go-mod-version.outputs.go-version-mod }}
            tinygo-version: "0.35.0"

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Setup Fastly CLI
        uses: fastly/compute-actions/setup@v11

      - name: Symlink Viceroy to expected location
        run: |
          fastly version
          ln -s "$(which viceroy)" "${XDG_CONFIG_HOME:-$HOME/.config}/fastly/viceroy"

      - name: Tests - Go
        run: make test-go

      # Test TinyGo once Go tests have passed

      - uses: acifani/setup-tinygo@v2
        with:
          tinygo-version: ${{ matrix.tinygo-version }}

      - name: Tests - TinyGo
        run: make test-tinygo
